<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo dõi Vote YVote</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .candidate-card {
            transition: all 0.3s ease;
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .vote-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .last-update {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-3 position-absolute top-0 end-0">
        {% if is_authenticated %}
            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">Đăng xuất</a>
        {% else %}
            <a href="{{ url_for('login') }}" class="btn btn-primary">Đăng nhập</a>
        {% endif %}
    </div>
    <div class="container py-5">
        <h1 class="text-center mb-4">Theo dõi Vote YVote</h1>
        <div class="text-center mb-4">
            <span class="last-update">Cập nhật lần cuối: <span id="lastUpdate">-</span></span>
        </div>
        <ul class="nav nav-tabs mb-3" id="boardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tabA" data-bs-toggle="tab" data-bs-target="#boardA" type="button" role="tab">Bảng A</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tabB" data-bs-toggle="tab" data-bs-target="#boardB" type="button" role="tab">Bảng B</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tabC" data-bs-toggle="tab" data-bs-target="#boardC" type="button" role="tab">Bảng C</button>
            </li>
        </ul>
        <div class="tab-content" id="boardTabsContent">
            <div class="tab-pane fade show active" id="boardA" role="tabpanel"></div>
            <div class="tab-pane fade" id="boardB" role="tabpanel"></div>
            <div class="tab-pane fade" id="boardC" role="tabpanel"></div>
        </div>
        <div class="mt-4" id="historyTableContainer"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let prevData = {A: {}, B: {}, C: {}};
        function updateVoteData() {
            fetch('/api/vote-data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('lastUpdate').textContent = data.A.last_update || '-';
                    ['A','B','C'].forEach(board => {
                        const container = document.getElementById('board'+board);
                        container.innerHTML = '';
                        if (!data[board] || !data[board].candidates) return;
                        let html = '<div class="row">';
                        data[board].candidates.forEach(candidate => {
                            let prev = prevData[board][candidate.name];
                            let delta = null, color = '', arrow = '';
                            if (prev !== undefined) {
                                delta = +(candidate.percent - prev).toFixed(2);
                                if (delta > 0) { color = 'green'; arrow = '↑'; }
                                else if (delta < 0) { color = 'red'; arrow = '↓'; }
                                else { color = 'black'; arrow = '→'; }
                            }
                            html += `<div class='col-md-4 mb-4'><div class='card candidate-card'><div class='card-body text-center'>` +
                                `<h5 class='card-title'>${candidate.name}</h5>` +
                                `<div class='vote-count'>${candidate.percent}%` +
                                (delta !== null ? ` <span style='color:${color};font-size:1.2em;'>${arrow} ${delta>0?'+':''}${delta}</span>` : '') +
                                `</div><p class='card-text'>Tỉ lệ bình chọn</p></div></div></div>`;
                            prevData[board][candidate.name] = candidate.percent;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    });
                })
                .catch(error => console.error('Error:', error));
        }
        setInterval(updateVoteData, 10000);
        updateVoteData();
    </script>
    {% if not is_authenticated %}
    <script>
        // Hide 10m and 1h options and limit select for unauthenticated users
        document.addEventListener('DOMContentLoaded', function() {
            const intervalSelect = document.getElementById('intervalSelect');
            const limitSelectContainer = document.getElementById('limitSelectContainer');

            // Remove 10m and 1h options
            const option10m = intervalSelect.querySelector('option[value="10m"]');
            const option1h = intervalSelect.querySelector('option[value="1h"]');
            if (option10m) option10m.remove();
            if (option1h) option1h.remove();

            // Hide limit select
            if (limitSelectContainer) {
                limitSelectContainer.style.display = 'none';
                // Although hidden, set default limit to 10 to be sure
                const limitSelect = document.getElementById('limitSelect');
                if (limitSelect) limitSelect.value = '10';
            }
            
            // Update the form submit listener to ensure limit is 10 for public
            document.getElementById('filterForm').addEventListener('submit', function(e) {
                // The fetch call already handles the limit parameter, 
                // and backend enforces 10 for unauthenticated users.
                // No need to change the fetch call here, just ensure the limit select value is 10 (though it's hidden).
                const limitSelect = document.getElementById('limitSelect');
                 if (limitSelect) limitSelect.value = '10'; // Redundant, but safe
            }, { once: true }); // Add once: true to avoid adding multiple listeners if this script runs again
        });
    </script>
    {% endif %}
</body>
</html> 
